name: Into Main

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.summary.outputs.status }}
      details: ${{ steps.summary.outputs.details }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint bash scripts
        run: shellcheck --shell=bash src/*.sh .devcontainer/*.sh || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Run pre-commit
        id: pre-commit
        run: pre-commit run --all-files --show-diff-on-failure || echo "pre-commit failed"

      - name: Check PR title & commits
        if: github.event_name == 'pull_request'
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set summary
        id: summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "status=âœ… success" >> "$GITHUB_OUTPUT"
            echo "details=All validation checks passed" >> "$GITHUB_OUTPUT"
          else
            echo "status=âŒ failed" >> "$GITHUB_OUTPUT"
            echo "details=One or more validation steps failed (see logs)" >> "$GITHUB_OUTPUT"
          fi

  test:
    name: Test Action
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.summary.outputs.status }}
      details: ${{ steps.summary.outputs.details }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run action
        id: action
        uses: ./
        with:
          who-to-greet: '${{ github.event_name }} Runner'

      - name: Verify outputs
        id: verify
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Greeting time: ${{ steps.action.outputs.time }}"

      - name: Set summary
        id: summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "status=âœ… success" >> "$GITHUB_OUTPUT"
            echo "details=Action test passed" >> "$GITHUB_OUTPUT"
          else
            echo "status=âŒ failed" >> "$GITHUB_OUTPUT"
            echo "details=Action test failed (see logs)" >> "$GITHUB_OUTPUT"
          fi

  release-preview:
    name: Release Preview
    needs: [validate, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      status: ${{ steps.summary.outputs.status }}
      details: ${{ steps.summary.outputs.details }}
      next_version: ${{ steps.dry-run.outputs.next_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install semantic-release
        run: |
          npm install --no-save \
            semantic-release \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            @semantic-release/changelog \
            @semantic-release/github \
            @semantic-release/git \
            conventional-changelog-conventionalcommits

      - name: Run dry-run
        id: dry-run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRY_OUTPUT=$(npx semantic-release --dry-run 2>&1) || true
          echo "$DRY_OUTPUT" > dry-run.log

          NEXT_VERSION=$(echo "$DRY_OUTPUT" | \
            grep -oE 'The next release version is [0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?' | \
            awk '{print $5}' || echo "no-release-pending")

          echo "next_version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Set summary
        id: summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "status=âœ… success" >> "$GITHUB_OUTPUT"
            echo "details=Dry-run completed. Next version: ${{ steps.dry-run.outputs.next_version }}" >> "$GITHUB_OUTPUT"
          else
            echo "status=âš ï¸ issue" >> "$GITHUB_OUTPUT"
            echo "details=Dry-run had issues (check logs)" >> "$GITHUB_OUTPUT"
          fi

  release:
    name: Release
    needs: [validate, test, release-preview]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    outputs:
      status: ${{ steps.summary.outputs.status }}
      details: ${{ steps.summary.outputs.details }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install semantic-release
        run: |
          npm install --no-save \
            semantic-release \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            @semantic-release/changelog \
            @semantic-release/github \
            @semantic-release/git \
            conventional-changelog-conventionalcommits

      - name: Run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Set summary
        id: summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "status=ğŸš€ published" >> "$GITHUB_OUTPUT"
            echo "details=Release published successfully" >> "$GITHUB_OUTPUT"
          else
            echo "status=âŒ failed" >> "$GITHUB_OUTPUT"
            echo "details=Release failed (check logs)" >> "$GITHUB_OUTPUT"
          fi

  reporter:
    name: Report Status
    needs: [validate, test, release-preview, release]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Post or update PR comment
        if: github.event_name == 'pull_request' && always()
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### Workflow Summary â€“ Pull Request

            **Repository**: ${{ github.repository }}
            **Run**: #${{ github.run_id }}
            **Last updated**: ${{ github.event.head_commit.timestamp || 'N/A' }}

            **Next Release Preview**: ${{ needs.release-preview.outputs.next_version || 'unknown' }}

            **Job Results**

            | Job              | Status | Result                  |
            |------------------|--------|-------------------------|
            | Validate         | ${{ needs.validate.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.validate.outputs.status || 'N/A' }} |
            | Test             | ${{ needs.test.result     == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.test.outputs.status || 'N/A' }}     |
            | Release Preview  | ${{ needs['release-preview'].result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs['release-preview'].outputs.status || 'N/A' }} |
            | Release          | ${{ needs.release.result   == 'success' && 'ğŸš€' || 'âŒ' }} | ${{ needs.release.outputs.status || 'N/A' }} |

            **Details**
            - Validate: ${{ needs.validate.outputs.details || 'N/A' }}
            - Test: ${{ needs.test.outputs.details || 'N/A' }}
            - Release Preview: ${{ needs['release-preview'].outputs.details || 'N/A' }}
            - Release: ${{ needs.release.outputs.details || 'N/A' }}

            See logs in Actions UI for full details.
          edit-mode: replace
